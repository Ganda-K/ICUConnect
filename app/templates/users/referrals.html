{% extends "users/base.html" %} {% block content %}
<div class="container-fluid">
	<div class="row mb-4">
		<div class="col-12">
			<div class="d-flex justify-content-between align-items-center">
				<h2><i class="fas fa-exchange-alt me-2"></i>ICU Referrals</h2>
				<div class="d-flex gap-2">
					<button class="btn btn-outline-primary" id="refreshBtn">
						<i class="fas fa-sync-alt"></i> Refresh
					</button>
					<a href="{{ url_for('user.dashboard') }}" class="btn btn-primary">
						<i class="fas fa-map"></i> View Map
					</a>
				</div>
			</div>
		</div>
	</div>

	<!-- Referral Statistics -->
	<div class="row mb-4">
		<div class="col-md-3">
			<div class="card stat-card">
				<div class="card-body">
					<h5 class="card-title">Pending Referrals</h5>
					<div class="d-flex justify-content-between align-items-center">
						<h2 class="mb-0" id="pendingCount">0</h2>
						<div class="icon-circle bg-warning">
							<i class="fas fa-clock"></i>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="col-md-3">
			<div class="card stat-card">
				<div class="card-body">
					<h5 class="card-title">Accepted Today</h5>
					<div class="d-flex justify-content-between align-items-center">
						<h2 class="mb-0" id="acceptedCount">0</h2>
						<div class="icon-circle bg-success">
							<i class="fas fa-check"></i>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="col-md-3">
			<div class="card stat-card">
				<div class="card-body">
					<h5 class="card-title">Rejected Today</h5>
					<div class="d-flex justify-content-between align-items-center">
						<h2 class="mb-0" id="rejectedCount">0</h2>
						<div class="icon-circle bg-danger">
							<i class="fas fa-times"></i>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="col-md-3">
			<div class="card stat-card">
				<div class="card-body">
					<h5 class="card-title">Avg Response Time</h5>
					<div class="d-flex justify-content-between align-items-center">
						<h2 class="mb-0" id="avgResponseTime">0s</h2>
						<div class="icon-circle bg-info">
							<i class="fas fa-stopwatch"></i>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Referrals List -->
	<div class="row">
		<div class="col-12">
			<div class="card">
				<div class="card-header">
					<h5 class="card-title mb-0">All Referrals</h5>
					<div class="d-flex gap-2">
						<select
							class="form-select form-select-sm"
							id="statusFilter"
							style="width: auto">
							<option value="all">All Statuses</option>
							<option value="pending">Pending</option>
							<option value="accepted">Accepted</option>
							<option value="rejected">Rejected</option>
							<option value="escalated">Escalated</option>
						</select>
					</div>
				</div>
				<div class="card-body p-0">
					<div class="table-responsive">
						<table class="table table-hover mb-0">
							<thead class="table-light">
								<tr>
									<th>Patient</th>
									<th>From/To</th>
									<th>Reason</th>
									<th>Status</th>
									<th>Time</th>
									<th>Actions</th>
								</tr>
							</thead>
							<tbody id="referralsTableBody">
								<!-- Referrals will be populated here -->
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- Referral Response Modal -->
<div class="modal fade" id="referralResponseModal" tabindex="-1">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">ICU Referral Request</h5>
				<button
					type="button"
					class="btn-close"
					data-bs-dismiss="modal"></button>
			</div>
			<div class="modal-body">
				<div id="referralDetails">
					<!-- Referral details will be populated here -->
				</div>
				<div class="alert alert-warning mt-3">
					<i class="fas fa-clock"></i>
					<strong>Time Remaining:</strong> <span id="timeRemaining">2:00</span>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-success" id="acceptReferralBtn">
					<i class="fas fa-check"></i> Accept Referral
				</button>
				<button type="button" class="btn btn-danger" id="rejectReferralBtn">
					<i class="fas fa-times"></i> Reject Referral
				</button>
			</div>
		</div>
	</div>
</div>

<!-- Rejection Reason Modal -->
<div class="modal fade" id="rejectionReasonModal" tabindex="-1">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">Rejection Reason</h5>
				<button
					type="button"
					class="btn-close"
					data-bs-dismiss="modal"></button>
			</div>
			<div class="modal-body">
				<div class="mb-3">
					<label class="form-label"
						>Please provide a reason for rejection:</label
					>
					<textarea
						class="form-control"
						id="rejectionReason"
						rows="3"
						placeholder="Explain why this referral cannot be accepted..."></textarea>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
					Cancel
				</button>
				<button type="button" class="btn btn-danger" id="confirmRejectBtn">
					<i class="fas fa-times"></i> Confirm Rejection
				</button>
			</div>
		</div>
	</div>
</div>

<!-- Notification Sound -->
<audio id="notificationSound" preload="auto" loop>
	<source
		src="{{ url_for('static', filename='sounds/notificationsound.mp3') }}"
		type="audio/mpeg" />
</audio>
{% endblock %} {% block scripts %}
<script>
	let map;
	let markers = [];
	let activeReferrals = [];
	let notificationInterval;
	let currentReferralId = null;
	let handledReferrals = [];
	let notificationAudio = null;
	let countdownInterval = null;

	// Initialize map and referral system
	document.addEventListener('DOMContentLoaded', function () {
		notificationAudio = document.getElementById('notificationSound');
		loadAllReferrals();
		setupEventListeners();
		startNotificationCheck();
	});

	function loadAllReferrals() {
		fetch('/referrals/api/all-referrals')
			.then((response) => response.json())
			.then((data) => {
				if (data.success) {
					activeReferrals = data.referrals;
					updateReferralsTable();
					updateStatistics();
				}
			})
			.catch((error) => {
				console.error('Error loading referrals:', error);
			});
	}

	function updateReferralsTable() {
		const tbody = document.getElementById('referralsTableBody');
		const statusFilter = document.getElementById('statusFilter').value;

		tbody.innerHTML = '';

		if (activeReferrals.length === 0) {
			tbody.innerHTML =
				'<tr><td colspan="6" class="text-center text-muted">No referrals found</td></tr>';
			return;
		}

		// Filter referrals based on status
		let filteredReferrals = activeReferrals;
		if (statusFilter !== 'all') {
			filteredReferrals = activeReferrals.filter(
				(ref) => ref.status.toLowerCase() === statusFilter
			);
		}

		filteredReferrals.forEach((referral) => {
			const row = document.createElement('tr');
			const statusBadge = getStatusBadge(referral.status);
			const directionText =
				referral.direction === 'Received'
					? `From: ${referral.requesting_hospital}`
					: `To: ${referral.target_hospital}`;

			row.innerHTML = `
	            <td>
	                
	                <small class="text-muted">${referral.patient_age} years, ${
				referral.patient_gender
			}</small>
	            </td>
	            <td>${directionText}</td>
	            <td>${referral.reason}</td>
	            <td>${statusBadge}</td>
	            <td>
	                ${
										referral.status === 'Pending'
											? `<span class="badge bg-warning">${Math.floor(
													referral.time_remaining
											  )}s</span>`
											: `<small class="text-muted">${formatTime(
													referral.created_at
											  )}</small>`
									}
	            </td>
	            <td>
	                ${
										referral.status === 'Pending' && referral.is_target
											? `<button class="btn btn-sm btn-success me-1" onclick="acceptReferral(${referral.id})">
	                        <i class="fas fa-check"></i>
	                    </button>
	                    <button class="btn btn-sm btn-danger" onclick="rejectReferral(${referral.id})">
	                        <i class="fas fa-times"></i>
	                    </button>`
											: `<button class="btn btn-sm btn-outline-secondary" onclick="viewReferralDetails(${referral.id})">
	                        <i class="fas fa-eye"></i>
	                    </button>`
									}
	            </td>
	        `;
			tbody.appendChild(row);
		});
	}

	function getStatusBadge(status) {
		const badges = {
			Pending: 'bg-warning',
			Accepted: 'bg-success',
			Rejected: 'bg-danger',
			Escalated: 'bg-info',
		};
		return `<span class="badge ${
			badges[status] || 'bg-secondary'
		}">${status}</span>`;
	}

	function formatTime(isoString) {
		const date = new Date(isoString);
		return date.toLocaleString();
	}

	function setupEventListeners() {
		// New referral button
		document
			.getElementById('newReferralBtn')
			.addEventListener('click', function () {
				document.getElementById('referralForm').reset();
				document.getElementById('targetHospitalSelect').focus();
			});

		// Referral form submission
		document
			.getElementById('referralForm')
			.addEventListener('submit', function (e) {
				e.preventDefault();
				submitReferral();
			});

		// Refresh button
		document
			.getElementById('refreshBtn')
			.addEventListener('click', function () {
				loadAllReferrals();
			});

		// Accept referral
		document
			.getElementById('acceptReferralBtn')
			.addEventListener('click', function () {
				acceptReferral();
			});

		// Reject referral
		document
			.getElementById('rejectReferralBtn')
			.addEventListener('click', function () {
				document.getElementById('rejectionReasonModal').classList.add('show');
				document.getElementById('rejectionReasonModal').style.display = 'block';
			});

		// Confirm rejection
		document
			.getElementById('confirmRejectBtn')
			.addEventListener('click', function () {
				const reason = document.getElementById('rejectionReason').value;
				if (reason.trim()) {
					rejectReferral(reason);
				} else {
					alert('Please provide a reason for rejection.');
				}
			});
	}

	function submitReferral() {
		const formData = {
			patient_age: parseInt(document.getElementById('patientAge').value),
			patient_gender: document.getElementById('patientGender').value,
			target_hospital_id: document.getElementById('targetHospitalSelect').value,
			primary_diagnosis: document.getElementById('primaryDiagnosis').value,
			current_treatment: document.getElementById('currentTreatment').value,
			urgency: document.getElementById('urgencyLevel').value,
			reason: document.getElementById('reasonForReferral').value,
			special_requirements: document.getElementById('specialRequirements')
				.value,
		};

		fetch('/referrals/api/initiate-referral', {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
			},
			body: JSON.stringify(formData),
		})
			.then((response) => response.json())
			.then((data) => {
				if (data.success) {
					alert('Referral sent successfully!');
					document.getElementById('referralForm').reset();
					loadAllReferrals();
				} else {
					alert('Error: ' + data.message);
				}
			})
			.catch((error) => {
				console.error('Error:', error);
				alert('Error sending referral');
			});
	}

	function updateStatistics() {
		document.getElementById('pendingCount').textContent =
			activeReferrals.length;
		// Other statistics would be updated here
	}

	function startNotificationCheck() {
		setInterval(() => {
			fetch('/referrals/api/pending-referrals')
				.then((response) => response.json())
				.then((data) => {
					if (data.success && data.referrals.length > 0) {
						const pending = data.referrals.filter(
							(ref) => !handledReferrals.includes(ref.id)
						);
						if (pending.length > 0) {
							const latest = pending[0];
							showReferralModal(latest);
							playNotificationSound();
							handledReferrals.push(latest.id);
						}
					}
				});
		}, 5000);
	}

	function showReferralModal(referral) {
		currentReferralId = referral.id;
		document.getElementById('referralDetails').innerHTML = `
	        <div class="row">
	            <div class="col-md-6">
	                <h6>Patient Information</h6>
	                <p><strong>Age:</strong> ${referral.patient_age}</p>
	                <p><strong>Gender:</strong> ${referral.patient_gender}</p>
	                ${
										referral.primary_diagnosis
											? `<p><strong>Primary Diagnosis:</strong> ${referral.primary_diagnosis}</p>`
											: ''
									}
	            </div>
	            <div class="col-md-6">
	                <h6>Referral Details</h6>
	                <p><strong>From:</strong> ${referral.requesting_hospital}</p>
	                <p><strong>Urgency:</strong> ${referral.urgency}</p>
	                <p><strong>Reason:</strong> ${referral.reason}</p>
	                ${
										referral.current_treatment
											? `<p><strong>Current Treatment:</strong> ${referral.current_treatment}</p>`
											: ''
									}
	            </div>
	        </div>
	        ${
						referral.special_requirements
							? `<p><strong>Special Requirements:</strong> ${referral.special_requirements}</p>`
							: ''
					}
	    `;
		startCountdown(120); // Always start at 2 minutes
		const modal = new bootstrap.Modal(
			document.getElementById('referralResponseModal')
		);
		modal.show();
	}

	function startCountdown(initialTime) {
		let timeLeft =
			typeof initialTime === 'number' && initialTime > 0 ? initialTime : 120;
		const timeElement = document.getElementById('timeRemaining');
		clearInterval(countdownInterval);
		countdownInterval = setInterval(() => {
			const minutes = Math.floor(timeLeft / 60);
			const seconds = timeLeft % 60;
			timeElement.textContent = `${minutes}:${seconds
				.toString()
				.padStart(2, '0')}`;
			if (timeLeft <= 0) {
				clearInterval(countdownInterval);
				stopNotificationSound();
				if (currentReferralId) {
					escalateReferral(currentReferralId);
				}
			}
			timeLeft--;
		}, 1000);
	}

	function acceptReferral() {
		if (!currentReferralId) return;
		stopNotificationSound();
		clearInterval(countdownInterval);
		fetch('/referrals/api/respond-to-referral', {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
			},
			body: JSON.stringify({
				referral_id: currentReferralId,
				response_type: 'accept',
				response_message: 'Referral accepted',
			}),
		})
			.then((response) => response.json())
			.then((data) => {
				if (data.success) {
					alert('Referral accepted successfully!');
					bootstrap.Modal.getInstance(
						document.getElementById('referralResponseModal')
					).hide();
					currentReferralId = null;
					loadAllReferrals();
				} else {
					alert('Error: ' + data.message);
				}
			})
			.catch((error) => {
				console.error('Error:', error);
				alert('Error accepting referral');
			});
	}

	function rejectReferral(reason) {
		if (!currentReferralId) return;
		stopNotificationSound();
		clearInterval(countdownInterval);
		fetch('/referrals/api/respond-to-referral', {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
			},
			body: JSON.stringify({
				referral_id: currentReferralId,
				response_type: 'reject',
				response_message: reason,
			}),
		})
			.then((response) => response.json())
			.then((data) => {
				if (data.success) {
					alert('Referral rejected');
					bootstrap.Modal.getInstance(
						document.getElementById('referralResponseModal')
					).hide();
					bootstrap.Modal.getInstance(
						document.getElementById('rejectionReasonModal')
					).hide();
					document.getElementById('rejectionReason').value = '';
					currentReferralId = null;
					loadAllReferrals();
				} else {
					alert('Error: ' + data.message);
				}
			})
			.catch((error) => {
				console.error('Error:', error);
				alert('Error rejecting referral');
			});
	}

	function escalateReferral(referralId) {
		fetch(`/referrals/api/escalate-referral/${referralId}`, {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
			},
		})
			.then((response) => response.json())
			.then((data) => {
				if (data.success) {
					alert(`Referral escalated to ${data.target_hospital}`);
					loadAllReferrals();
				} else {
					alert('Error: ' + data.message);
				}
			})
			.catch((error) => {
				console.error('Error:', error);
				alert('Error escalating referral');
			});
	}

	function playNotificationSound() {
		if (notificationAudio) {
			notificationAudio.currentTime = 0;
			notificationAudio.play().catch(() => {});
		}
	}

	function stopNotificationSound() {
		if (notificationAudio) {
			notificationAudio.pause();
			notificationAudio.currentTime = 0;
		}
	}
</script>
{% endblock %}
