{% extends "users/base.html" %} {% block content %}
<div class="container-fluid">
	<div class="row mb-4">
		<!-- Bed Statistics Cards -->
		<div class="col-md-4">
			<div class="card stat-card">
				<div class="card-body">
					<h5 class="card-title">Total Beds</h5>
					<div class="d-flex justify-content-between align-items-center">
						<h2 class="mb-0">{{ hospital.total_beds }}</h2>
						<div class="icon-circle bg-primary">
							<i class="fas fa-bed"></i>
						</div>
					</div>
					<p class="card-text text-muted mt-2">All ICU beds in your facility</p>
				</div>
			</div>
		</div>

		<div class="col-md-4">
			<div class="card stat-card">
				<div class="card-body">
					<h5 class="card-title">Occupied Beds</h5>
					<div class="d-flex justify-content-between align-items-center">
						<h2 class="mb-0">
							{{ hospital.total_beds - hospital.available_beds }}
						</h2>
						<div class="icon-circle bg-warning">
							<i class="fas fa-procedures"></i>
						</div>
					</div>
					<p class="card-text text-muted mt-2">Currently in use</p>
				</div>
			</div>
		</div>

		<div class="col-md-4">
			<div class="card stat-card">
				<div class="card-body">
					<h5 class="card-title">Available Beds</h5>
					<div class="d-flex justify-content-between align-items-center">
						<h2 class="mb-0">{{ hospital.available_beds }}</h2>
						<div class="icon-circle bg-success">
							<i class="fas fa-check-circle"></i>
						</div>
					</div>
					<p class="card-text text-muted mt-2">Ready for new admissions</p>
				</div>
			</div>
		</div>
	</div>

	<!-- Map and Referral Section -->
	<div class="row">
		<!-- Map Section -->
		<div class="col-md-8">
			<div class="card">
				<div class="card-header">
					<h5 class="card-title mb-0">Kisumu County ICU Bed Availability</h5>
				</div>
				<div class="card-body p-0">
					<div id="map"></div>
				</div>
			</div>
		</div>

		<!-- Referral Form Section -->
		<div class="col-md-4">
			<div class="card" id="referralFormCard" style="display: none">
				<div class="card-header">
					<h5 class="card-title mb-0">ICU Referral Request</h5>
					<small class="text-muted">For new patients who need transfer</small>
					<button
						type="button"
						class="btn-close float-end"
						onclick="closeReferralForm()"></button>
				</div>
				<div class="card-body">
					<form id="referralForm">
						<!-- Patient Information -->
						<div class="row mb-3">
							<div class="col">
								<label class="form-label">Age</label>
								<input
									type="number"
									class="form-control"
									id="patientAge"
									placeholder="Age"
									min="0"
									max="150"
									required />
							</div>
							<div class="col">
								<label class="form-label">Gender</label>
								<select class="form-select" id="patientGender" required>
									<option value="">Select...</option>
									<option value="Male">Male</option>
									<option value="Female">Female</option>
									<option value="Other">Other</option>
								</select>
							</div>
						</div>

						<!-- Target Hospital (hidden field) -->
						<input type="hidden" id="targetHospitalId" />

						<!-- Selected Hospital Display -->

						<div
							class="mb-3"
							id="selectedHospitalDisplay"
							style="display: none">
							<label class="form-label">Selected Hospital</label>
							<div class="alert alert-info">
								<strong id="selectedHospitalName"></strong>
							</div>
						</div>

						<div class="mb-3">
							<label class="form-label">Primary Diagnosis</label>
							<input
								type="text"
								class="form-control"
								id="primaryDiagnosis"
								placeholder="e.g., Severe Pneumonia"
								autocomplete="off" />
						</div>

						<!-- Reason for Referral -->
						<div class="mb-3">
							<label class="form-label">Patient's Condition</label>
							<textarea
								class="form-control"
								id="reasonForReferral"
								rows="3"
								placeholder="Current status of the patient"
								required></textarea>
						</div>

						<div class="mb-3">
							<label class="form-label">Current Treatment</label>
							<textarea
								class="form-control"
								id="currentTreatment"
								rows="2"
								placeholder="Medications, interventions, etc."></textarea>
						</div>

						<!-- Special Requirements -->
						<div class="mb-3">
							<label class="form-label">Special Requirements</label>
							<textarea
								class="form-control"
								id="specialRequirements"
								rows="2"
								placeholder="Equipment, specialists, Allergies..."></textarea>
						</div>

						<!-- Submit Button -->
						<button
							type="submit"
							class="btn btn-primary w-100"
							id="submitReferralBtn">
							<i class="fas fa-paper-plane"></i> Send Referral Request
						</button>
					</form>
				</div>
			</div>

			<!-- Patient Transfers -->
			<div class="card">
				<div class="card-header">
					<h6 class="card-title mb-0">Patient Transfers</h6>
				</div>
				<div class="card-body p-0">
					<div id="patientTransfersList" class="list-group list-group-flush">
						<div class="p-3 text-muted">No active patient transfers</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- Referral Response Modal -->
<div class="modal fade" id="referralResponseModal" tabindex="-1">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">ICU Referral Request</h5>
				<button
					type="button"
					class="btn-close"
					data-bs-dismiss="modal"></button>
			</div>
			<div class="modal-body">
				<div id="referralDetails"></div>
				<div class="alert alert-warning mt-3">
					<i class="fas fa-clock"></i>
					<strong>Time Remaining:</strong> <span id="timeRemaining">2:00</span>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-success" id="acceptReferralBtn">
					<i class="fas fa-check"></i> Accept Referral
				</button>
				<button type="button" class="btn btn-danger" id="rejectReferralBtn">
					<i class="fas fa-times"></i> Reject Referral
				</button>
			</div>
		</div>
	</div>
</div>

<!-- Rejection Reason Modal -->
<div class="modal fade" id="rejectionReasonModal" tabindex="-1">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">Rejection Reason</h5>
				<button
					type="button"
					class="btn-close"
					data-bs-dismiss="modal"></button>
			</div>
			<div class="modal-body">
				<div class="mb-3">
					<label class="form-label"
						>Please provide a reason for rejection:</label
					>
					<textarea
						class="form-control"
						id="rejectionReason"
						rows="3"
						placeholder="Explain why this referral cannot be accepted..."></textarea>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
					Cancel
				</button>
				<button type="button" class="btn btn-danger" id="confirmRejectBtn">
					<i class="fas fa-times"></i> Confirm Rejection
				</button>
			</div>
		</div>
	</div>
</div>

{% endblock %} {% block scripts %}
<script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
<script>
	// Global variables
	let activeTransfers = [];
	let activeReferrals = [];
	let currentTransferId = null;
	let currentReferralId = null;
	let notificationInterval;
	let countdownInterval;
	let soundInterval;
	let isSoundPlaying = false;
	let currentNotification = null;
	let audioEnabled = false; // Track if user has enabled audio
	let userSettings = null; // Store user notification settings
	let audioMessageShown = false; // Track if we've shown the audio enable message
	let firstReferralPoll = true;

	document.addEventListener('DOMContentLoaded', function() {
	    // Load user settings first
	    loadUserSettings().then(() => {
	        // Initialize map
	        initMap();

	        // Initialize transfer system
	        initTransferSystem();

	        // Setup event listeners
	        setupEventListeners();

	        // Enable audio on first user interaction if settings allow
	        if (userSettings && userSettings.audio_notifications) {
	            document.addEventListener('click', function enableAudio() {
	                if (!audioEnabled) {
	                    const audio = document.getElementById('notificationSound');
	                    if (audio) {
	                        audio.play().then(() => {
	                            audio.pause();
	                            audio.currentTime = 0;
	                            audioEnabled = true;
	                            audioMessageShown = false; // Reset the message flag
	                            console.log('Audio enabled on user interaction');

	                            // Save the audio enabled status to database
	                            saveAudioEnabledStatus(true);
	                        }).catch(e => {
	                            console.log('Audio still not enabled:', e);
	                        });
	                    }
	                }
	                // Remove the event listener after first interaction
	                document.removeEventListener('click', enableAudio);
	            }, { once: true });
	        }
	    });

	    // Global modal cleanup listener
	    document.addEventListener('click', function(e) {
	        // If clicking on backdrop, clean up
	        if (e.target.classList.contains('modal-backdrop')) {
	            cleanupModalArtifacts();
	        }
	    });

	    // Listen for modal hidden events
	    document.addEventListener('hidden.bs.modal', function(e) {
	        cleanupModalArtifacts();
	    });
	});

	function loadUserSettings() {
	    console.log('Loading user settings...');
	    return fetch('/user/api/settings')
	        .then(response => {
	            console.log('Settings API response status:', response.status);
	            return response.json();
	        })
	        .then(data => {
	            console.log('Settings API response data:', data);
	            if (data.success) {
	                userSettings = data.settings;
	                console.log('User settings loaded successfully:', userSettings);

	                // Set audio volume - wait for audio element to be available
	                setTimeout(() => {
	                    const audio = document.getElementById('notificationSound');
	                    if (audio) {
	                        audio.volume = userSettings.audio_volume;
	                        console.log('Audio volume set to:', userSettings.audio_volume);

	                        // Test if audio can actually play (browser autoplay policy)
	                        if (userSettings.audio_enabled && userSettings.audio_notifications) {
	                            testAudioPlayability();
	                        }
	                    } else {
	                        console.warn('Audio element not found when setting volume');
	                    }
	                }, 100);
	            } else {
	                console.error('Settings API returned success: false');
	            }
	        })
	        .catch(error => {
	            console.error('Error loading user settings:', error);
	            // Use default settings if loading fails
	            userSettings = {
	                audio_notifications: true,
	                visual_notifications: true,
	                browser_notifications: false,
	                audio_volume: 0.7,
	                audio_enabled: false,
	                referral_notifications: true,
	                bed_status_notifications: true,
	                system_notifications: true,
	                notification_duration: 120,
	                auto_escalate: true
	            };
	            console.log('Using default settings:', userSettings);
	        });
	}

	function testAudioPlayability() {
	    const audio = document.getElementById('notificationSound');
	    if (!audio) return;

	    // Try to play a silent sound to test if audio is allowed
	    const originalVolume = audio.volume;
	    audio.volume = 0; // Silent test

	    audio.play().then(() => {
	        audio.pause();
	        audio.currentTime = 0;
	        audio.volume = originalVolume;
	        audioEnabled = true;
	        audioMessageShown = false; // Reset the message flag
	        console.log('Audio playability test passed - audio is enabled');
	    }).catch(e => {
	        audio.volume = originalVolume;
	        audioEnabled = false;
	        console.log('Audio playability test failed - user interaction required:', e);
	    });
	}

	function saveAudioEnabledStatus(enabled) {
	    console.log('Saving audio enabled status:', enabled);
	    fetch('/user/api/settings', {
	        method: 'POST',
	        headers: {
	            'Content-Type': 'application/json',
	        },
	        body: JSON.stringify({ audio_enabled: enabled })
	    })
	    .then(response => {
	        console.log('Save settings response status:', response.status);
	        return response.json();
	    })
	    .then(data => {
	        console.log('Save settings response data:', data);
	        if (data.success) {
	            console.log('Audio enabled status saved successfully:', enabled);
	        } else {
	            console.error('Failed to save audio enabled status');
	        }
	    })
	    .catch(error => {
	        console.error('Error saving audio enabled status:', error);
	    });
	}

	function initMap() {
	    const map = L.map('map').setView([-0.1022, 34.7617], 10);
	    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
	        attribution: '© OpenStreetMap'
	    }).addTo(map);

	    // Load Kisumu County boundary
	    fetch("/user/kisumu-geojson")
	        .then((response) => response.json())
	        .then((data) => {
	            console.log('GeoJSON loaded:', data);

	            // Handle GeometryCollection format
	            if (data.type === 'GeometryCollection') {
	                const multiPolygon = data.geometries.find(
	                    (g) => g.type === 'MultiPolygon'
	                );

	                if (multiPolygon) {
	                    const feature = {
	                        type: 'Feature',
	                        properties: {},
	                        geometry: multiPolygon,
	                    };

	                    const countyLayer = L.geoJSON(feature, {
	                        style: {
	                            color: '#3388ff',
	                            weight: 3,
	                            opacity: 1,
	                            fillOpacity: 0.2,
	                            fillColor: '#3388ff',
	                        },
	                    }).addTo(map);

	                    map.fitBounds(countyLayer.getBounds());
	                    map.setMaxBounds(countyLayer.getBounds().pad(0.5));
	                }
	            }
	        })
	        .catch((error) => {
	            console.error('Error loading Kisumu boundary:', error);
	        });

	    // Load hospitals data
	    const hospitals = {{ hospitals_data|tojson|safe }};

	    hospitals.forEach(hospital => {
	        if (!hospital.lat || !hospital.lng) return;

	        const color = getAvailabilityColor(hospital.available, hospital.beds);
	        const icon = createHospitalIcon(color, hospital.available);

	        const marker = L.marker([hospital.lat, hospital.lng], { icon }).addTo(map)
	            .bindPopup(`
	                <div class="hospital-popup">
	                    <h6><strong>${hospital.name}</strong></h6>
	                    ${hospital.level ? `<p>Level: <strong>${hospital.level}</strong></p>` : ''}
	                    <p>Total Beds: <strong>${hospital.beds}</strong></p>
	                    <p>Available: <strong>${hospital.available}</strong></p>
	                    <button class="btn btn-sm btn-primary mt-2 w-100 select-hospital-btn"
	                            data-hospital-id="${hospital.id}"
	                            data-hospital-name="${hospital.name}">
	                        Select for Referral
	                    </button>
	                </div>
	            `);

	        marker.on('popupopen', function() {
	            document.querySelector('.select-hospital-btn').addEventListener('click', function() {
	                const hospitalId = this.dataset.hospitalId;
	                const hospitalName = this.dataset.hospitalName;

	                document.getElementById('targetHospitalId').value = hospitalId;
	                document.getElementById('selectedHospitalName').textContent = hospitalName;
	                document.getElementById('selectedHospitalDisplay').style.display = 'block';
	                document.getElementById('referralFormCard').style.display = 'block';

	                // Scroll to form
	                document.getElementById('referralFormCard').scrollIntoView({
	                    behavior: 'smooth',
	                    block: 'start'
	                });
	            });
	        });
	    });
	}

	function getAvailabilityColor(available, total) {
	    if (total <= 0) return 'gray';
	    const percentage = (available / total) * 100;

	    // More appropriate thresholds for ICU beds
	    if (percentage >= 50) return 'green';      // Good availability (≥50%)
	    if (percentage >= 20) return 'orange';     // Limited availability (20-49%)
	    return 'red';                              // Critical availability (<20%)
	}

	function createHospitalIcon(color, available) {
	    return L.divIcon({
	        className: 'custom-marker',
	        html: `
	            <div class="marker-pin" style="background-color:${color}">
	                <span>${available}</span>
	            </div>
	        `,
	        iconSize: [30, 42],
	        iconAnchor: [15, 42]
	    });
	}

	function initTransferSystem() {
	    // Load any existing active transfers
	    loadActiveTransfers();
	}

	function loadActiveTransfers() {
	    fetch('/transfers/api/active-transfers')
	        .then(response => {
	            if (!response.ok) {
	                throw new Error(`HTTP error! status: ${response.status}`);
	            }
	            const contentType = response.headers.get('content-type');
	            if (!contentType || !contentType.includes('application/json')) {
	                throw new Error(`Expected JSON but got ${contentType}`);
	            }
	            return response.json();
	        })
	        .then(data => {
	            if (data.success) {
	                activeTransfers = data.transfers;
	                updateActiveTransfersList();
	            }
	        })
	        .catch(error => {
	            console.error('Error loading transfers:', error);
	            console.error('This might indicate an authentication or server issue');
	            // Don't show error to user for polling requests
	        });
	}

	function showVisualNotification(referral) {
	    // Check if visual notifications are enabled in user settings
	    if (!userSettings || !userSettings.visual_notifications) {
	        console.log('Visual notifications disabled in user settings');
	        return;
	    }

	    // Remove any existing notification
	    if (currentNotification) {
	        currentNotification.remove();
	    }

	    const notification = document.createElement('div');
	    notification.className = 'position-fixed notification-alert';
	    notification.style.cssText = `
	        top: 20px; right: 20px; z-index: 9999;
	        background: #dc3545; color: white; padding: 15px 25px;
	        border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
	        cursor: pointer; animation: fadeIn 0.3s;
	    `;
	    notification.innerHTML = `
	        <div class="d-flex align-items-center">
	            <i class="fas fa-bell me-2"></i>
	            <div>
	                <strong>NEW ICU TRANSFER REQUEST!</strong><br>
	                <small>Click to view details</small>
	            </div>
	        </div>
	    `;

	    notification.addEventListener('click', () => {
	        showReferralModal(referral); // Only open the modal when the notification is clicked
	        notification.remove();
	        currentNotification = null;
	    });

	    document.body.appendChild(notification);
	    currentNotification = notification;
	}

	function showReferralModal(referralOrTransfer) {
	    // Support both referral and transfer objects
	    const isTransfer = referralOrTransfer.hasOwnProperty('status');
	    const data = referralOrTransfer;
	    if (isTransfer && data.to_hospital !== undefined && data.to_hospital != undefined && data.to_hospital == '{{ hospital.name }}') {
	        currentTransferId = data.id;
	    } else if (!isTransfer && data.target_hospital_id == {{ hospital.id }}) {
	        currentReferralId = data.id;
	    }

	    document.getElementById('referralDetails').innerHTML = `
	        <div class="row">
	            <div class="col-md-6">
	                <h6>Patient Information</h6>
	                <p><strong>Age:</strong> ${data.patient_age}</p>
	                <p><strong>Gender:</strong> ${data.patient_gender}</p>
	                ${data.primary_diagnosis ? `<p><strong>Primary Diagnosis:</strong> ${data.primary_diagnosis}</p>` : ''}
	            </div>
	            <div class="col-md-6">
	                <h6>Referral Details</h6>
	                <p><strong>From:</strong> ${isTransfer ? data.from_hospital : data.requesting_hospital}</p>
	                <p><strong>Urgency:</strong> ${isTransfer ? data.urgency_level : data.urgency}</p>
	                <p><strong>Reason:</strong> ${data.reason || ''}</p>
	                ${data.current_treatment ? `<p><strong>Current Treatment:</strong> ${data.current_treatment}</p>` : ''}
	            </div>
	        </div>
	        ${data.special_requirements ? `<p><strong>Special Requirements:</strong> ${data.special_requirements}</p>` : ''}
	    `;

	    startCountdown(data.time_remaining);
	    new bootstrap.Modal(document.getElementById('referralResponseModal')).show();
	}

	function startCountdown(seconds) {
	    // Clear any existing countdown
	    if (countdownInterval) clearInterval(countdownInterval);

	    // Use user's notification duration setting if available, otherwise use provided seconds
	    const notificationDuration = userSettings ? userSettings.notification_duration : 120;
	    const timeElement = document.getElementById('timeRemaining');
	    let remaining = seconds || notificationDuration;

	    countdownInterval = setInterval(() => {
	        const mins = Math.floor(remaining / 60);
	        const secs = remaining % 60;
	        timeElement.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;

	        if (remaining <= 0) {
	            clearInterval(countdownInterval);
	            // Stop the notification sound
	            stopNotificationSound();
	            // Remove the visual notification
	            if (currentNotification) {
	                currentNotification.remove();
	                currentNotification = null;
	            }
	            // Close the modal
	            closeReferralModal();
	            // Remove expired transfer from active list
	            if (currentTransferId) {
	                activeTransfers = activeTransfers.filter(tr => tr.id !== currentTransferId);
	                updateActiveTransfersList();
	                // Only auto-escalate if user has enabled it
	                if (userSettings && userSettings.auto_escalate) {
	                    checkAndEscalateTransfer(currentTransferId);
	                }
	            }
	        }
	        remaining--;
	    }, 1000);
	}

	function checkAndEscalateTransfer(transferId) {
	    fetch(`/transfers/api/check-transfer-status/${transferId}`)
	        .then(response => response.json())
	        .then(data => {
	            if (data.success && data.status === 'Pending') {
	                if (data.requesting_hospital_id == {{ hospital.id }}) {
	                    escalateTransfer(transferId);
	                }
	            }
	        })
	        .catch(error => console.error('Error checking transfer:', error));
	}

	function escalateTransfer(transferId) {
	    fetch(`/transfers/api/escalate-transfer/${transferId}`, {
	        method: 'POST'
	    })
	        .then(response => response.json())
	        .then(data => {
	            if (data.success) {
	                showAlert(`Transfer escalated to ${data.target_hospital}`, 'info');
	                if (data.new_transfer_id) {
	                    startTransferTracking(data.new_transfer_id, 120);
	                }
	                loadActiveTransfers();
	            } else {
	                showAlert(data.message, 'error');
	            }
	        })
	        .catch(error => console.error('Error escalating transfer:', error));
	}

	function setupEventListeners() {
	    // Referral form submission
	    document.getElementById('referralForm').addEventListener('submit', function(e) {
	        e.preventDefault();
	        submitReferral();
	    });

	    // Accept referral button
	    document.getElementById('acceptReferralBtn').addEventListener('click', function() {
	        acceptReferral();
	    });

	    // Reject referral button
	    document.getElementById('rejectReferralBtn').addEventListener('click', function() {
	        new bootstrap.Modal(document.getElementById('rejectionReasonModal')).show();
	    });

	    // Confirm rejection button
	    document.getElementById('confirmRejectBtn').addEventListener('click', function() {
	        const reason = document.getElementById('rejectionReason').value;
	        if (reason.trim()) {
	            rejectReferral(reason);
	        } else {
	            showAlert('Please provide a reason for rejection.', 'error');
	        }
	    });

	    // Mark as admitted button
	    document.getElementById('markAdmittedBtn').addEventListener('click', function() {
	        if (currentTransferId) {
	            markAsAdmitted(currentTransferId);
	        }
	    });
	}

	function submitReferral() {
	    const formData = {
	        target_hospital_id: document.getElementById('targetHospitalId').value,
	        patient_age: document.getElementById('patientAge').value,
	        patient_gender: document.getElementById('patientGender').value,
	        primary_diagnosis: document.getElementById('primaryDiagnosis').value,
	        current_treatment: document.getElementById('currentTreatment').value,
	        reason: document.getElementById('reasonForReferral').value,
	        special_requirements: document.getElementById('specialRequirements').value
	    };

	    // Validate form
	    if (!formData.target_hospital_id) {
	        showAlert('Please select a target hospital', 'error');
	        return;
	    }

	    const submitBtn = document.getElementById('submitReferralBtn');
	    submitBtn.disabled = true;
	    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';

	    fetch('/referrals/api/initiate-referral', {
	        method: 'POST',
	        headers: {
	            'Content-Type': 'application/json',
	        },
	        body: JSON.stringify(formData)
	    })
	        .then(response => response.json())
	        .then(data => {
	            if (data.success) {
	                showAlert(data.message, 'success');
	                closeReferralForm();
	            } else {
	                showAlert(data.message, 'error');
	            }
	        })
	        .catch(error => {
	            console.error('Error:', error);
	            showAlert('An error occurred while sending the referral', 'error');
	        })
	        .finally(() => {
	            submitBtn.disabled = false;
	            submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Send Referral Request';
	        });
	}

	function acceptReferral() {
	    if (!currentReferralId) return;

	    fetch('/referrals/api/respond-to-referral', {
	        method: 'POST',
	        headers: {
	            'Content-Type': 'application/json',
	        },
	        body: JSON.stringify({
	            referral_id: currentReferralId,
	            response_type: 'accept',
	            response_message: 'Referral accepted'
	        })
	    })
	        .then(response => response.json())
	        .then(data => {
	            if (data.success) {
	                // Stop the notification sound
	                stopNotificationSound();
	                // Remove the visual notification
	                if (currentNotification) {
	                    currentNotification.remove();
	                    currentNotification = null;
	                }
	                showAlert('Referral accepted successfully!', 'success');
	                closeReferralModal();
	                cleanupModalArtifacts();
	                loadActiveTransfers();
	            } else {
	                showAlert(data.message, 'error');
	            }
	        })
	        .catch(error => {
	            console.error('Error:', error);
	            showAlert('Error accepting referral', 'error');
	        });
	}

	function rejectReferral(reason) {
	    if (!currentReferralId) return;

	    fetch('/referrals/api/respond-to-referral', {
	        method: 'POST',
	        headers: {
	            'Content-Type': 'application/json',
	        },
	        body: JSON.stringify({
	            referral_id: currentReferralId,
	            response_type: 'reject',
	            response_message: reason
	        })
	    })
	        .then(response => response.json())
	        .then(data => {
	            if (data.success) {
	                // Stop the notification sound
	                stopNotificationSound();
	                showAlert('Referral rejected', 'info');
	                closeReferralModal();
	                closeRejectionModal();
	                cleanupModalArtifacts();
	                loadActiveTransfers();
	            } else {
	                showAlert(data.message, 'error');
	            }
	        })
	        .catch(error => {
	            console.error('Error:', error);
	            showAlert('Error rejecting referral', 'error');
	        });
	}

	function markAsAdmitted(transferId) {
	    const arrivalNotes = document.getElementById('arrivalNotes')?.value || '';

	    fetch('/transfers/api/update-transfer-status', {
	        method: 'POST',
	        headers: {
	            'Content-Type': 'application/json',
	        },
	        body: JSON.stringify({
	            transfer_id: transferId,
	            status: 'Admitted',
	            arrival_notes: arrivalNotes
	        })
	    })
	        .then(response => response.json())
	        .then(data => {
	            if (data.success) {
	                showAlert('Patient marked as admitted successfully!', 'success');
	                // Close the modal if it's open
	                const modal = bootstrap.Modal.getInstance(document.getElementById('referralResponseModal'));
	                if (modal) {
	                    modal.hide();
	                }
	                cleanupModalArtifacts();
	                loadActiveTransfers();
	            } else {
	                showAlert(data.message, 'error');
	            }
	        })
	        .catch(error => {
	            console.error('Error:', error);
	            showAlert('Error updating transfer status', 'error');
	        });
	}

	function cleanupModalArtifacts() {
	    // Remove any remaining modal backdrops
	    const backdrops = document.querySelectorAll('.modal-backdrop');
	    backdrops.forEach(backdrop => backdrop.remove());

	    // Remove modal-open class from body
	    document.body.classList.remove('modal-open');
	    document.body.style.overflow = '';
	    document.body.style.paddingRight = '';

	    // Reset current IDs
	    currentTransferId = null;
	    currentReferralId = null;

	    console.log('Modal artifacts cleaned up');
	}

	function closeReferralForm() {
	    document.getElementById('referralForm').reset();
	    document.getElementById('referralFormCard').style.display = 'none';
	    document.getElementById('selectedHospitalDisplay').style.display = 'none';
	}

	function closeReferralModal() {
	    const modal = bootstrap.Modal.getInstance(document.getElementById('referralResponseModal'));
	    if (modal) {
	        modal.hide();
	        // Remove any remaining backdrop
	        const backdrop = document.querySelector('.modal-backdrop');
	        if (backdrop) {
	            backdrop.remove();
	        }
	        // Remove modal-open class from body
	        document.body.classList.remove('modal-open');
	        document.body.style.overflow = '';
	        document.body.style.paddingRight = '';
	    }
	}

	function closeRejectionModal() {
	    document.getElementById('rejectionReason').value = '';
	    const modal = bootstrap.Modal.getInstance(document.getElementById('rejectionReasonModal'));
	    if (modal) {
	        modal.hide();
	        // Remove any remaining backdrop
	        const backdrop = document.querySelector('.modal-backdrop');
	        if (backdrop) {
	            backdrop.remove();
	        }
	        // Remove modal-open class from body
	        document.body.classList.remove('modal-open');
	        document.body.style.overflow = '';
	        document.body.style.paddingRight = '';
	    }
	}

	function clearSelectedHospital() {
	    document.getElementById('targetHospitalId').value = '';
	    document.getElementById('selectedHospitalDisplay').style.display = 'none';
	}

	function updateActiveTransfersList() {
	    const container = document.getElementById('patientTransfersList');
	    if (!container) return;

	    container.innerHTML = '';

	    const enRouteTransfers = activeTransfers.filter(tr => tr.status === 'En Route');
	    if (enRouteTransfers.length === 0) {
	        container.innerHTML = '<div class="p-3 text-muted">No active patient transfers</div>';
	        return;
	    }

	    enRouteTransfers.forEach(transfer => {
	        const item = document.createElement('div');
	        item.className = 'list-group-item';

	        const statusBadge = '<span class="badge bg-warning">En Route</span>';
	        const actionButton = transfer.is_receiving ?
	            `<a class="btn btn-sm btn-success" href="/admissions/admissions?transfer_id=${transfer.id}">
	                <i class="fas fa-check"></i> Mark Admitted
	            </a>` : '';

	        item.innerHTML = `
	            <div class="d-flex justify-content-between align-items-start">
	                <div class="flex-grow-1">
	                    <h6 class="mb-1">(${transfer.patient_age} years, ${transfer.patient_gender})</h6>
	                    <small class="text-muted">
	                        <strong>From:</strong> ${transfer.from_hospital}
	                        <strong>To:</strong> ${transfer.to_hospital}
	                    </small>
	                    <br>
	                    <small class="text-muted">
	                        <strong>Diagnosis:</strong> ${transfer.primary_diagnosis || 'Not specified'}
	                    </small>
	                    <br>
	                    <small class="text-muted">
	                        <strong>Urgency:</strong> ${transfer.urgency_level}
	                    </small>
	                </div>
	                <div class="text-end ms-3">
	                    ${statusBadge}
	                    <br>
	                    <small class="text-muted">
	                        <strong>Started:</strong> ${transfer.transfer_initiated_at}
	                    </small>
	                    ${actionButton}
	                </div>
	            </div>
	        `;

	        container.appendChild(item);
	    });
	}

	function showAlert(message, type) {
	    const alertDiv = document.createElement('div');
	    alertDiv.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
	    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
	    alertDiv.innerHTML = `
	        ${message}
	        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
	    `;

	    document.body.appendChild(alertDiv);

	    setTimeout(() => {
	        if (alertDiv.parentNode) {
	            alertDiv.remove();
	        }
	    }, 5000);
	}

	function testNotificationSound() {
	    console.log('Testing notification sound...');
	    console.log('Audio enabled:', audioEnabled);
	    console.log('Is sound playing:', isSoundPlaying);

	    const audio = document.getElementById('notificationSound');
	    if (!audio) {
	        console.error('Audio element not found');
	        showAlert('Audio element not found', 'error');
	        return;
	    }

	    console.log('Audio element found:', audio);
	    console.log('Audio src:', audio.src);
	    console.log('Audio readyState:', audio.readyState);

	    // Try to play the sound
	    audio.currentTime = 0;
	    audio.play().then(() => {
	        console.log('Test sound played successfully');
	        showAlert('Test sound played successfully!', 'success');
	        audioEnabled = true;
	    }).catch(e => {
	        console.error('Test sound failed:', e);
	        showAlert(`Test sound failed: ${e.message}`, 'error');

	        if (e.name === 'NotAllowedError') {
	            showAlert('Browser blocked autoplay. Please click anywhere on the page first.', 'warning');
	        }
	    });
	}

	// --- SOCKET.IO REAL-TIME REFERRALS ---
	const socket = io();
	socket.on('connect', function() {
	    console.log('Connected to WebSocket server');
	});
	socket.on('new_referral', function(referral) {
	    if (referral.target_hospital_id == {{ hospital.id }}) {
	        showVisualNotification(referral); // Only show the notification and play sound
	        playNotificationSound();
	    }
	});

	function playNotificationSound() {
	    // Check if audio notifications are enabled in user settings
	    if (!userSettings || !userSettings.audio_notifications) {
	        console.log('Audio notifications disabled in user settings');
	        return;
	    }

	    const audio = document.getElementById('notificationSound');
	    if (!audio) {
	        console.error('Audio element not found');
	        return;
	    }

	    if (isSoundPlaying) {
	        console.log('Sound already playing');
	        return;
	    }

	    // Check if audio is enabled (user has interacted with the page)
	    if (!audioEnabled) {
	        console.log('Audio not enabled - user needs to interact with page first');
	        // Try to enable audio by attempting to play
	        audio.play().then(() => {
	            audio.pause();
	            audio.currentTime = 0;
	            audioEnabled = true;
	            console.log('Audio enabled successfully');
	            // Save the audio enabled status to database
	            saveAudioEnabledStatus(true);
	            // Now try to play the notification sound
	            playNotificationSound();
	        }).catch(e => {
	            console.log('Audio not enabled yet:', e);
	            // Only show the message once per session
	            if (!audioMessageShown) {
	                showAlert('Click anywhere on the page to enable notification sounds', 'info');
	                audioMessageShown = true;
	            }
	        });
	        return;
	    }

	    isSoundPlaying = true;
	    console.log('Starting notification sound');

	    // Set volume from user settings
	    audio.volume = userSettings.audio_volume || 0.7;

	    // Function to restart the sound when it ends
	    const restartSound = () => {
	        if (isSoundPlaying) {
	            console.log('Restarting notification sound');
	            audio.currentTime = 0;
	            audio.play().catch(e => {
	                console.log('Audio restart failed:', e);
	                isSoundPlaying = false;
	            });
	        }
	    };

	    // Store the restart function reference for later removal
	    audio.restartSound = restartSound;

	    // Listen for when the sound ends to restart it
	    audio.addEventListener('ended', restartSound);

	    // Start playing
	    audio.currentTime = 0;
	    audio.play().catch(e => {
	        console.log('Audio play failed:', e);
	        isSoundPlaying = false;
	        // If autoplay is blocked, try alternative method
	        if (e.name === 'NotAllowedError') {
	            console.log('Trying alternative sound method...');
	            playSoundAlternative();
	        }
	    });
	}

	function stopNotificationSound() {
	    const audio = document.getElementById('notificationSound');
	    if (audio) {
	        isSoundPlaying = false;
	        audio.pause();
	        audio.currentTime = 0;

	        // Remove the restart function if it exists
	        if (audio.restartSound) {
	            audio.removeEventListener('ended', audio.restartSound);
	            audio.restartSound = null;
	        }

	        console.log('Notification sound stopped');
	    }
	}
</script>

{% endblock %}
