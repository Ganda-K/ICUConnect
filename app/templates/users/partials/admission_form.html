<div class="slide-in-form" id="admissionForm">
	<div class="d-flex justify-content-between align-items-center mb-4">
		<h4>New Admission</h4>
		<button class="btn-close" id="closeFormBtn"></button>
	</div>

	<form id="admissionFormData">
		<input type="hidden" name="hospital_id" value="{{ hospital.id }}" />

		<div class="mb-3">
			<label class="form-label">Patient Name</label>
			<input
				type="text"
				class="form-control"
				name="patient_name"
				autocomplete="off"
				required />
		</div>

		<div class="row mb-3">
			<div class="col">
				<label class="form-label">Age</label>
				<input type="number" class="form-control" name="age" />
			</div>
			<div class="col">
				<label class="form-label">Gender</label>
				<select class="form-select" name="gender">
					<option value="Male">Male</option>
					<option value="Female">Female</option>
					<option value="Other">Other</option>
				</select>
			</div>
		</div>

		<div class="mb-3">
			<label class="form-label">Bed Assignment</label>

			<select class="form-select" name="bed_number" id="bedSelect" required>
				<option value="">Select available bed</option>
				<!-- Options will be added by JavaScript -->
			</select>
			<div class="form-text">
				Currently available:
				<span id="availableBedsCount">loading...</span> beds
			</div>
		</div>

		<div class="mb-3">
			<label class="form-label">Admitting Doctor</label>
			<input
				type="text"
				class="form-control"
				name="doctor"
				value="{{ current_user.name }}"
				required />
		</div>

		<div class="mb-3">
			<label class="form-label">Reason for Admission</label>
			<textarea class="form-control" name="reason" rows="3" required></textarea>
		</div>

		<div class="mb-3">
			<label class="form-label">Priority</label>
			<div class="btn-group w-100" role="group">
				<input
					type="radio"
					class="btn-check"
					name="priority"
					id="priorityLow"
					value="Low"
					autocomplete="off" />
				<label class="btn btn-outline-success" for="priorityLow">Low</label>

				<input
					type="radio"
					class="btn-check"
					name="priority"
					id="priorityMedium"
					value="Medium"
					autocomplete="off"
					checked />
				<label class="btn btn-outline-warning" for="priorityMedium"
					>Medium</label
				>

				<input
					type="radio"
					class="btn-check"
					name="priority"
					id="priorityHigh"
					value="High"
					autocomplete="off" />
				<label class="btn btn-outline-danger" for="priorityHigh">High</label>
			</div>
		</div>

		<div class="d-grid gap-2">
			<button type="submit" class="btn btn-primary">
				<i class="fas fa-bed me-2"></i>Admit Patient
			</button>
		</div>
	</form>
</div>
<div class="overlay" id="formOverlay"></div>

<script>
	document.addEventListener('DOMContentLoaded', function () {
		const bedSelect = document.getElementById('bedSelect');
		const countSpan = document.getElementById('availableBedsCount');

		// Show loading state
		bedSelect.disabled = true;
		countSpan.textContent = 'loading...';

		fetch('/admissions/api/available-beds')
			.then((response) => {
				if (!response.ok) throw new Error('Network error');
				return response.json();
			})
			.then((data) => {
				// Clear existing options except the default
				bedSelect.innerHTML = '<option value="">Select available bed</option>';

				if (data.availableBeds.length === 0) {
					bedSelect.innerHTML =
						'<option value="" disabled>No beds available</option>';
					countSpan.textContent = '0';
					return;
				}

				// Add bed options
				data.availableBeds.forEach((bed) => {
					const option = new Option(
						`Bed ${bed.number}`, // Display text
						bed.number // Submit value (bed ID)
					);
					bedSelect.add(option);
				});

				countSpan.textContent = data.count;
				bedSelect.disabled = false;
			}) // âœ… Closed the .then properly
			.catch((error) => {
				console.error('Error fetching beds:', error);
				bedSelect.innerHTML =
					'<option value="" disabled>Error loading beds</option>';
				countSpan.textContent = 'error';
			});
	});
</script>
