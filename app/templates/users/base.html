<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>ICUConnect - {% block title %}{% endblock %}</title>
		<!-- Bootstrap CSS -->
		<link
			href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
			rel="stylesheet" />
		<!-- Font Awesome -->
		<link
			rel="stylesheet"
			href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
		<!-- Leaflet CSS -->
		<link
			rel="stylesheet"
			href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
		<!-- Custom CSS -->
		<link
			rel="stylesheet"
			href="{{ url_for('static', filename='css/styles.css') }}" />
		<style>
			@media (max-width: 768px) {
				#sidebarCollapseBtn {
					display: none !important;
				}
			}
		</style>
	</head>
	<body>
		<div class="wrapper">
			<nav id="sidebar" class="d-flex flex-column">
				<div>
					<div
						class="sidebar-header d-flex align-items-center justify-content-between px-3 py-4">
						<h3 class="mb-0">ICUConnect</h3>
						<button
							id="sidebarCollapseBtn"
							class="btn btn-sm btn-outline-light ms-2"
							type="button"
							title="Collapse sidebar">
							<i id="sidebarCollapseIcon" class="fas fa-chevron-left"></i>
						</button>
					</div>
					<ul class="list-unstyled components">
						<li
							class="{% if request.endpoint == 'user.dashboard' %}active{% endif %}">
							<a href="{{ url_for('user.dashboard') }}">
								<i class="fas fa-tachometer-alt"></i>
								<span class="sidebar-label">Dashboard</span>
							</a>
						</li>
						<li
							class="{% if request.endpoint == 'admission.admissions' %}active{% endif %}">
							<a href="{{ url_for('admission.admissions') }}">
								<i class="fas fa-procedures"></i>
								<span class="sidebar-label">Admissions</span>
							</a>
						</li>
						<li
							class="{% if request.endpoint == 'discharge.discharges' %}active{% endif %}">
							<a href="{{ url_for('discharge.discharges') }}">
								<i class="fas fa-hospital-user"></i>
								<span class="sidebar-label">Discharges</span>
							</a>
						</li>
						<li
							class="{% if request.endpoint == 'user.guide' %}active{% endif %}">
							<a href="{{ url_for('user.guide') }}">
								<i class="fas fa-book"></i>
								<span class="sidebar-label">User Guide</span>
							</a>
						</li>
						<li
							class="{% if request.endpoint == 'user.settings' %}active{% endif %}">
							<a href="{{ url_for('user.settings') }}">
								<i class="fas fa-cog"></i>
								<span class="sidebar-label">Settings</span>
							</a>
						</li>
						<li>
							<a href="{{ url_for('auth.logout') }}">
								<i class="fas fa-sign-out-alt"></i>
								<span class="sidebar-label">Logout</span>
							</a>
						</li>
					</ul>
				</div>
				<div class="footer">
					<p>&copy; 2025 ICUConnect</p>
				</div>
			</nav>

			<div id="content">
				<nav class="navbar navbar-expand-lg navbar-light bg-light">
					<div class="container-fluid">
						<button
							id="mobileSidebarToggle"
							class="btn"
							type="button"
							aria-label="Toggle sidebar">
							<i class="fas fa-bars"></i>
						</button>
						<div class="time-display ms-auto">
							<h5 id="greeting">
								Good {{ get_greeting() }}, {{ current_user.hospital.name }}
							</h5>
							<div id="datetime">{{ current_datetime() }}</div>
						</div>
						<div class="d-flex">
							<button class="btn btn-outline-secondary me-2" id="searchBtn">
								<i class="fas fa-search"></i>
							</button>
							<button
								class="btn btn-outline-secondary"
								id="icuPredictionBtn"
								title="Predict ICU Occupancy">
								<i class="fas fa-bell"></i>
								<span class="badge bg-danger">Prediction</span>
							</button>
						</div>
					</div>
				</nav>

				{% block content %}{% endblock %}
			</div>
		</div>

		<!-- Modal Forms Container -->
		<div id="modalFormsContainer">{% block modal_forms %}{% endblock %}</div>

		<!-- jQuery, Bootstrap JS -->
		<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
		<!-- Leaflet JS -->
		<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
		<!-- Custom JS -->
		<script src="{{ url_for('static', filename='js/main.js') }}"></script>
		{% block scripts %}{% endblock %}

		<!-- ICU Prediction Modal -->
		<div
			class="modal fade"
			id="icuPredictionModal"
			tabindex="-1"
			aria-labelledby="icuPredictionModalLabel"
			aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="icuPredictionModalLabel">
							ICU Occupancy Prediction
						</h5>
						<button
							type="button"
							class="btn-close"
							data-bs-dismiss="modal"
							aria-label="Close"></button>
					</div>
					<div class="modal-body" id="icuPredictionResult">
						<!-- Result will be injected here -->
					</div>
				</div>
			</div>
		</div>

		<script>
			document.getElementById('icuPredictionBtn').addEventListener('click', function() {
			    // You can set the ICU bed capacity here, or fetch it dynamically if needed
			    const icuBedCapacity = {{ current_user.hospital.total_beds|default(20) }};
			    fetch('/api/predict/occupancy', {
			        method: 'POST',
			        headers: {
			            'Content-Type': 'application/json'
			        },
			        body: JSON.stringify({
			            weeks_ahead: 1,
			            icu_bed_capacity: icuBedCapacity
			        })
			    })
			    .then(response => response.json())
			    .then(data => {
			        let html = '';
			        if (data.error) {
			            html = `<div class="alert alert-danger">${data.error}</div>`;
			        } else {
			            html = `
			                <div>
			                    <strong>Prediction for ${data.dates[0]}:</strong>
			                    <h3>${data.predictions[0]}</h3>
			                </div>
			                <div class="mt-3">
			                    <strong>Status:</strong>
			                    ${data.surge_alert ?
			                        '<span class="badge bg-danger">Surge Alert</span>' :
			                        '<span class="badge bg-success">Normal</span>'}
			                </div>
			                <div class="mt-2">${data.description}</div>
			            `;
			        }
			        document.getElementById('icuPredictionResult').innerHTML = html;
			        var myModal = new bootstrap.Modal(document.getElementById('icuPredictionModal'));
			        myModal.show();
			    })
			    .catch(err => {
			        document.getElementById('icuPredictionResult').innerHTML = `<div class="alert alert-danger">Error: ${err}</div>`;
			        var myModal = new bootstrap.Modal(document.getElementById('icuPredictionModal'));
			        myModal.show();
			    });
			});

			document.addEventListener('DOMContentLoaded', function () {
				const sidebar = document.getElementById('sidebar');
				const collapseBtn = document.getElementById('sidebarCollapseBtn');
				const collapseIcon = document.getElementById('sidebarCollapseIcon');
				collapseBtn.addEventListener('click', function () {
					sidebar.classList.toggle('collapsed');
					// Flip the chevron icon
					collapseIcon.classList.toggle('fa-chevron-left');
					collapseIcon.classList.toggle('fa-chevron-right');
				});
			});

			// Responsive sidebar toggle for mobile
			const mobileSidebarToggle = document.getElementById('mobileSidebarToggle');
			const sidebar = document.getElementById('sidebar');

			mobileSidebarToggle && mobileSidebarToggle.addEventListener('click', function(e) {
				e.preventDefault();
				sidebar.classList.toggle('active');
				// Optionally add an overlay
				let overlay = document.getElementById('sidebarOverlay');
				if (!overlay) {
					overlay = document.createElement('div');
					overlay.id = 'sidebarOverlay';
					overlay.style.position = 'fixed';
					overlay.style.top = 0;
					overlay.style.left = 0;
					overlay.style.width = '100vw';
					overlay.style.height = '100vh';
					overlay.style.background = 'rgba(0,0,0,0.3)';
					overlay.style.zIndex = 1999;
					document.body.appendChild(overlay);
					overlay.addEventListener('click', function() {
						sidebar.classList.remove('active');
						document.body.removeChild(overlay);
					});
				} else {
					document.body.removeChild(overlay);
				}
			});

			// Hide sidebar and overlay on resize if desktop
			window.addEventListener('resize', function() {
				if (window.innerWidth > 768) {
					sidebar.classList.remove('active');
					const overlay = document.getElementById('sidebarOverlay');
					if (overlay) document.body.removeChild(overlay);
				}
			});
		</script>
	</body>
</html>
